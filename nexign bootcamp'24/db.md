# Структура базы данных

## Физическая модель базы данных
![DB](./DB.png)

## Описание структуры

Каждый из микросервисов имеет собственную базу данных согласно своей зоне ответственности. Таким образом, проект содержит 4 базы данных:
- CDRg;
- BRT;
- HRS;
- CRM.

### CDRg

База данных сервиса “Генератор CDR”, содержащая информацию об абонентах и их звонках, генерируемых самим сервисом. Таблицы и их описание расположены в раскрывающихся элементах:

<details>
<summary>subscribers</summary>
Хранит номера телефонов абонентов. Выбранный тип данных для MSISDN обусловлен тем фактом, что звонки могут совершаться не только с российских номеров, при этом максимальная длина телефонного номера составляет 15 цифр.

![subscribers](https://sun9-63.userapi.com/impg/P-cOa2dA_4aRkUWDTsylErWWUmCQxmf6Gk-Wqg/MiRvVuTM8_4.jpg?size=917x174&quality=96&sign=14ebf4ca1a22b0572376eddff930ef84&type=album)
</details>

<details>
<summary>calls</summary>
Хранит информацию о звонках абонентов. Тип данных bigint для первичного ключа обусловлен бизнес-логикой процесса (звонков может быть много - гораздо больше, чем абонентов). 

![calls](https://sun9-11.userapi.com/impg/bomJOCNm_0EuRtl9witk1yZ14Fe91wv8KDdW4A/4TW8I7rhdD8.jpg?size=918x464&quality=96&sign=abda888932dec7fd4d17f4d1c9b2d3f0&type=album)

Атрибут “type” представляет собой enum из двух значений: ‘01’ и ‘02’ (исходящий и входящий вызовы соответственно).
</details>

### BRT
Содержит информацию об абонентах оператора “Ромашка”. 

<details>
<summary>subscribers</summary>

Для атрибута msisdn здесь был выбран тип данных char(11) исходя из предположения, что оператор обслуживает российские номера, содержащие 11 цифр.

Помимо атрибутов balance и balance_minutes, необходимых для выполнения задания, были добавлены также атрибуты balance_sms и balance_kilobytes, чтобы обеспечить расширяемость системы.  

![subscribers](https://sun9-38.userapi.com/impg/YvNllPySrIejru2NnCl3cKfZ9_9lD7BPmHBLBQ/kl4E43L6kes.jpg?size=919x559&quality=96&sign=1214e57aa4450b41be657443d5c06d21&type=album)

</details>

### HRS
Содержит информацию о тарифах оператора “Ромашка”.

<details>
<summary>tariffs</summary>

Поскольку необходимо было обеспечить возможность в будущем добавлять тарифы с новыми условиями, не прибегая к модификации базы данных, при проектировании выбор стоял между типом данных jsonb, поддерживаемым PostgreSQL, и подходом EAV (entity-attribute-value). Решено было остановиться на первом варианте, поскольку:
- данный формат занимает меньше места;
- упрощается чтение схемы;
- как правило, запросы выполняются быстрее, чем с EAV (хоть и не всегда).

![tariffs](https://sun9-60.userapi.com/impg/yPexarQ5pZp9vMuc8wek4s3ZZ2eoU4ztmLkTCQ/c4BWGYfdL68.jpg?size=921x302&quality=96&sign=de0ccca4cec2b466c55ed69ec12ad13c&type=album)

Примерное содержание таблицы:

![содержание](https://sun9-2.userapi.com/impg/bLA5VlwSArl5edSlTf-k62dS3PW9SMsvLVrzGQ/j3X64G3foZo.jpg?size=921x244&quality=96&sign=c9a6a84a6ce40b5daf2b202b492dea9f&type=album)
</details>

### CRM

База данных микросервиса CRM, в которой содержатся данные для аутентификации пользователя с ролью “Менеджер”. По-хорошему эта информация должна храниться в отдельном микросервисе для аутентификации и авторизации, но было принято решение оставить эти данные здесь во избежание усложнения системы в целом. 

Ещё одно замечание: в БД не хранится информация об абонентах, поскольку им предоставляется доступ к сервису только по номеру телефона. Таким образом, для предоставления прав абоненту необходимо убедиться, что его номер присутствует в BRT. 

<details>
<summary>managers</summary>

![managers](https://sun9-41.userapi.com/impg/KJXyOVb33OOzcpNXqj4t9zwwuDkVTgR-dc-HDg/0BpzL6yMlKQ.jpg?size=921x269&quality=96&sign=f5a2d34b2dca8b3e539f8e7f32e87662&type=album)
</details>

